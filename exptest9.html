<!doctype html>
<html>
   <head>
    	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js"></script>
    	<script src="jquery.overlaps.js"></script>
    	<script type="text/javascript" src="https://www.google.com/jsapi">

    	 </script>
		<style type="text/css">
			.hidden{visibility:hidden;}
		</style>
<script type = "text/JavaScript">
      google.load('visualization', '1', {packages:["corechart", 'table']}); 	
    	var randomPlacement = function(){
        randNum1 = Math.floor(Math.random()*winHeight);
        randNum2 = Math.floor(Math.random()*winWidth);
        ySector = Math.floor(gridSize*(10+randNum1)/winHeight);
	   		xSector = Math.floor(gridSize*(10+randNum2)/winWidth);
	   	};
    	
    	
    	var newScreen = function(t){
    	winWidth = $("#letters").width()-40;
			winHeight = $("#letters").height()-40;
			gridSize = 20;
			
			var u = 0;
			for (n=0; n<distractors.length;n++){					
				for (i=0;i < Math.floor(trialOrder[t][0]*distractors[n][1]);i++){
				  randomPlacement();
    			$("#letters").append(	"<div id='trial_" + t + "_letter_div_" + u +"' class=\
                        'letters trial_" + t + "' style= 'width:12px; color:none'>"
					    					+ distractors[n][0] + "</div>"); //adds letter
    			$("#trial_" + t + "_letter_div_"+ u).offset({ top: 10+randNum1, left: 10+randNum2}); //offsets letter to random position
					while($("#trial_" + t + "_letter_div_"+ u).overlaps($(".trial_" + t +".sector" + xSector + "_" + ySector))){
  					randomPlacement();
						$("#trial_" + t +"_letter_div_"+ u).offset({ top: 10+randNum1, left: 10+randNum2});
						
					} 
					$("#trial_" + t + "_letter_div_"+ u).addClass("placed");
					
    				for(k=0;k<=2;k++){
    					for(j=0;j<=2;j++){
    						$("#trial_" + t + "_letter_div_"+ u).addClass("sector" + (xSector+k-1) + "_" + (ySector+j-1));
    					}
    				}
    				u=u+1;
    			}		
    		}
			var rand = Math.random();
    		console.log(trialOrder[t]);
       		for (j=0;j<1;j++){
					  randomPlacement();
					  if (trialOrder[t][1]) {
					  	$("#letters").append(	"<div id='trial_" +t+"_targ_letter_div_" + j +"' class='\
												letters trial_" + t + "' style='width:12px; color:\
												none'>"+ target + "</div>");
					  }
					  else{
						  $("#letters").append(	"<div id='trial_" +t+"_targ_letter_div_" + j +"' class='\
												letters trial_" + t + "' style='width:12px; color:\
												none'>"+ distractors[Math.floor(Math.random()*distractors.length)][0] + "</div>");
					  }
	   				$("#trial_" +t+"_targ_letter_div_"+ j).offset({ top: 10+randNum1, left: 10+randNum2});
				    			
    				while($("#trial_" + t + "_targ_letter_div_"+j).overlaps($('.placed'))){
    					randomPlacement()
     					$("#trial_"+t+"_targ_letter_div_"+ j).offset({ top: 10+randNum1, left: 10+randNum2});
    				} 
    			}
	   	};
    	
    	$(document).ready(function(){
    		t=0;
    		$('body').append('<div id="letters" class="letters" style="width:2000px; height:2000px; background-color:none"></div>');
        	$('#letters').css({'height':(($(window).height())-50)+'px'});
        	$(window).resize(function(){
		        $('#letters').css({'height':(($(window).height())-50)+'px'});
    	    });
	    	$('#letters').css({'width':(($(window).width())-50)+'px'});

       		$(window).resize(function(){
       			$('#letters').css({'width':(($(window).width())-50)+'px'});
        	});        	
    	});
    	
//DEFINE YOUR PARAMETERS FOR THE EXPERIMENT
		numberDistractors = [	[4,8], //formatted as [number of distractors, number of trials]
     							        [8,8],
     							        [12,8],
           		  					[16,8],
     	        						[20,8],
     						        	[24,8],
             							[28,8]	
     			      				];
		distractors = [ ["O", .33], //formatted as [distractor, percentage of distractors]
						["R", .33],
						["Y", .33]	
						];
								
		target = "Q";
		percentagePresent = .5;
		
//END DEFINE PARAMETERS FOR EXPERIMENT

		trialOrder = [];
		for (i=0; i<numberDistractors.length;i++){
			for (n=0; n < Math.ceil(numberDistractors[i][1]*percentagePresent);n++){
				trialOrder[trialOrder.length] = [numberDistractors[i][0],true];
				//console.log(trialOrder.length);
				}
			for (n=0; n<Math.ceil(numberDistractors[i][1]/2);n++){
				trialOrder[trialOrder.length] = [numberDistractors[i][0],false];
				//console.log(trialOrder.length);
			}
		}

		var j, x, i = trialOrder.length;  //following while loop is variation on Fisher-Yates shuffle algorithm.  Shuffles trialOrder randomly.  
		while (i) { // same as while(i != 0)
		   j = parseInt(Math.random() * i);
		   x = trialOrder[--i];
		   trialOrder[i] = trialOrder[j];
		   trialOrder[j] = x;
		}
    	
    	select = true;
		trialResults = [];
		$(document).keydown(function(e) {
    		var code = (e.keyCode ? e.keyCode : e.which);
    		if (code == 32 && t<trialOrder.length && select == true ){
				//console.log(t);
				var t1= new Date();
				newScreen(t); 
				var t2= new Date();
				var keypress= t1.getTime();
				start=t2.getTime();
				var elapsed= (start-keypress)/1000;
				console.log(elapsed);
				select = false;
			}
    		if (code == 70 && t<trialOrder.length && select == false){
  				var t3 = new Date();
	    		end=t3.getTime();
	  			console.log(t);
		  		trialResults[t]= [t,trialOrder[t][0],trialOrder[t][1], true, (end-start)/1000];
			  	$("#letters").text("");
				  console.log(trialResults[t]);
  				select = true;
				  t=t+1;
			  }
			else if (code == 74 && t<trialOrder.length && select == false) {
				var t3 = new Date();
	    		end=t3.getTime();
				console.log(t);
				trialResults[t] = [t,trialOrder[t][0],trialOrder[t][1], false, (end-start)/1000];
				$("#letters").text("");
				console.log(trialResults[t]);
				select = true;
				t=t+1;
			}
			else if (code == 27){
			  t=trialOrder.length;
			  select = true;
			  $("#letters").text("");
			}
    });
    // Now that we have finished collecting the data, we will analyze it and present it as a chart    


    $(document).ready(function(){
      finishedChecker = window.setInterval(dataAnalysis, 500)
    });
    
    function drawChart(data1, data2, id){
      console.log('drawing chart');
      var dataTable = new google.visualization.DataTable();
      
      //declare columns
      dataTable.addColumn('number', 'Number of Distractors');
      dataTable.addColumn('number', 'Average Time Present');
      dataTable.addColumn('number', 'Average Time Absent');
      
      //Add data
      for (key in (presentMeans || absentMeans)){
      dataTable.addRow([  parseFloat(key), 
                          parseFloat(data1[key]['time']), 
                          parseFloat(data2[key]['time']) 
                        ]);
      }
      var options = { title: 'Time vs. Number of Distractors',
                      width: 800,
                      height: 600,
                      hAxis: {title: 'Number of Distractors', gridlines: {count: numberDistractors.length}},
                      vAxis: {title: 'Average Time (s)'}
                    };
      var chart = new google.visualization.ScatterChart(document.getElementById(id));
      chart.draw(dataTable, options);
      var table = new google.visualization.Table(document.getElementById('table_div'));
      var formatter = new google.visualization.NumberFormat({fractionDigits: 2})
      formatter.format(dataTable, 1)
      formatter.format(dataTable, 2)
      table.draw(dataTable, {allowHtml: true, showRowNumber:false, width: 600});
    }

    dataAnalysis = function(){
      if (t >= trialOrder.length){
        clearInterval(finishedChecker);
        console.log('running analysis');
        resultsPresent = [];
        resultsAbsent = [];
        presentMeans = {};
        absentMeans = {};
        for (m=0; m<trialResults.length; m++){
          if (trialResults[m][2]){
            resultsPresent[resultsPresent.length] = [trialResults[m][1], trialResults[m][3],trialResults[m][4]]
          }
          else {
            resultsAbsent[resultsAbsent.length] = [trialResults[m][1], trialResults[m][3],trialResults[m][4]]
          }
        }
        for (i=0; i<numberDistractors.length; i++){
          presentMeans[numberDistractors[i][0]] = {'time': 0, 'number': 0};
          absentMeans[numberDistractors[i][0]] = {'time': 0, 'number': 0};
        }
        for (m=0; m<resultsPresent.length;m++){
          if (resultsPresent[m][1]){            
            presentMeans[resultsPresent[m][0]]['time'] = (presentMeans[resultsPresent[m][0]]['time']*presentMeans[resultsPresent[m][0]]['number'] + resultsPresent[m][2])/(presentMeans[resultsPresent[m][0]]['number']+1)
            presentMeans[resultsPresent[m][0]]['number'] = presentMeans[resultsPresent[m][0]]['number'] + 1
          }
        }
        for (m=0; m<resultsAbsent.length;m++){
          if (!resultsAbsent[m][1]){
            absentMeans[resultsAbsent[m][0]]['time'] = (absentMeans[resultsAbsent[m][0]]['time']*absentMeans[resultsAbsent[m][0]]['number'] + resultsAbsent[m][2])/(absentMeans[resultsAbsent[m][0]]['number']+1)
            absentMeans[resultsAbsent[m][0]]['number'] = absentMeans[resultsAbsent[m][0]]['number'] + 1
          }
        }
// Regress the data using OLS to find the lines of best fit

        //start with presentMeans
        var sum = 0;
        for (key in presentMeans){
          sum = sum + parseFloat(presentMeans[key]['time']);
        }
        presentMeansAvg = sum/presentMeans.length;
        
        sum = 0;
        for (key in absentMeans){
          sum = sum + parseFloat(absentMeans[key]['time']);
        }
        absentMeansAvg = sum/absentMeans.length;
        var xBar = 0;
        for (i=0; i<numberDistractors.length; i++){
          xBar = xBar + numberDistractors[i][0];
        }
        xBar = xBar/numberDistractors.length;
        
        var sumSquares = {xx: 0, 
                          xy: {present: 0, absent: 0},
                          yy: {present: 0, absent: 0}
                          };
        //compute sumSquares
        for (i=0; i<numberDistractors.length; i++){
          sumSquares['xx'] = sumSquares.xx + (numberDistractors[i][0] - xBar)^2;
          sumSquares['xy']['present'] = sumSquares.xy.present +
                                    (parseFloat(presentMeans[numberDistractors[i][0]].time) - presentMeansAvg) *
                                    (numberDistractors[i][0] - xBar);
          sumSquares['xy']['absent'] = sumSquares.xy.absent +
                                    (parseFloat(absentMeans[numberDistractors[i][0]].time) - presentMeansAvg) *
                                    (numberDistractors[i][0] - xBar);
          sumSquares['yy']['present'] = sumSquares.yy.present +
                                    (parseFloat(presentMeans[numberDistractors[i][0]].time) - presentMeansAvg)^2;
          sumSquares['yy']['absent'] = sumSquares.yy.absent +
                                    (parseFloat(absentMeans[numberDistractors[i][0]].time) - presentMeansAvg)^2;
        }    
        
        var Coef = {present: {  b: sumSquares.xy.present/sumSquares.xx},
                    absent: {   b: sumSquares.xy.absent/sumSquares.xx}
                    };
        Coef['present']['a'] = presentMeansAvg - Coef.present.b*xBar;
        Coef['present']['r2'] = sumSquares.xy.present/(sumSquares.xx.present*sumSquares.yy.present);
        Coef['absent']['a'] = absentMeansAvg - Coef.absent.b*xBar;
        Coef['absent']['r2'] = sumSquares.xy.absent/(sumSquares.xx.absent*sumSquares.yy.absent);

              
    
//Print the graphs    
        console.log('done analysis');
        $('#letters').remove()
        $('body').append("<div id = 'chart_div' style = 'width:400; height:300'></div>");
        $('body').append("<div id = 'table_div' style = 'width:400; height:300'></div>");
        
        drawChart(presentMeans, absentMeans, 'chart_div');
/*      $('#chart_div').append('<p> The lines of best fit are given by y = a + bx: <\p>')
        $('#chart_div').append('<table> <tr> <th> Data Set </th> <th> a </th> <th> b </th> <th> R <sup> 2 </sup> </th> </tr>');
        for (key in Coef){
          $('#chart_div').append('<tr> <td>' + key + '</td>');
          for (val in Coef.key){
            $('#chart_div').append('<td>' + Coef.key.val + '</td>');
          }
          $('#chart_div').append('</tr>');
        }
        $('#chart_div').append('</table>'); */
      }
    }

</script>
   </head>
   
   <body id='body'>
   </body>
</html>